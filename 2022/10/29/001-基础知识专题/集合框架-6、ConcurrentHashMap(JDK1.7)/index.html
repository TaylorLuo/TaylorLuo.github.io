<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>JavaåŸºç¡€-é›†åˆæ¡†æ¶-6ã€ConcurrentHashMap(JDK1.7) | Taylor</title><meta name="keywords" content="JavaåŸºç¡€,é›†åˆæ¡†æ¶"><meta name="author" content="Taylor Luo"><meta name="copyright" content="Taylor Luo"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. Unsafe ä»‹ç»1.1. 1ã€Unsafe ç®€ä»‹Unsafe ç±»ç›¸å½“äºæ˜¯ä¸€ä¸ª java è¯­è¨€ä¸­çš„åé—¨ç±»ï¼Œæä¾›äº†ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œï¼Œæ‰€ä»¥åœ¨ä¸€äº›å¹¶å‘ç¼–ç¨‹ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚jdk å·²ç»ä½œå‡ºè¯´æ˜ï¼Œè¯¥ç±»å¯¹ç¨‹åºå‘˜è€Œè¨€ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ“ä½œï¼Œåœ¨åç»­çš„ jdk å‡çº§è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šç¦ç”¨è¯¥ç±»ã€‚æ‰€ä»¥è¿™ä¸ªç±»çš„ä½¿ç”¨æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå®é™…é¡¹ç›®ä¸­è°¨æ…ä½¿ç”¨ï¼Œä»¥å…é€ æˆ jdk å‡çº§ä¸å…¼å®¹é—®é¢˜ã€‚ 1.2. 2ã€Unsafe Apiè¿™é‡Œå¹¶ä¸"><meta property="og:type" content="article"><meta property="og:title" content="JavaåŸºç¡€-é›†åˆæ¡†æ¶-6ã€ConcurrentHashMap(JDK1.7)"><meta property="og:url" content="https://taylorluo.github.io/2022/10/29/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-6%E3%80%81ConcurrentHashMap(JDK1.7)/index.html"><meta property="og:site_name" content="Taylor"><meta property="og:description" content="1. Unsafe ä»‹ç»1.1. 1ã€Unsafe ç®€ä»‹Unsafe ç±»ç›¸å½“äºæ˜¯ä¸€ä¸ª java è¯­è¨€ä¸­çš„åé—¨ç±»ï¼Œæä¾›äº†ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œï¼Œæ‰€ä»¥åœ¨ä¸€äº›å¹¶å‘ç¼–ç¨‹ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚jdk å·²ç»ä½œå‡ºè¯´æ˜ï¼Œè¯¥ç±»å¯¹ç¨‹åºå‘˜è€Œè¨€ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ“ä½œï¼Œåœ¨åç»­çš„ jdk å‡çº§è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šç¦ç”¨è¯¥ç±»ã€‚æ‰€ä»¥è¿™ä¸ªç±»çš„ä½¿ç”¨æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå®é™…é¡¹ç›®ä¸­è°¨æ…ä½¿ç”¨ï¼Œä»¥å…é€ æˆ jdk å‡çº§ä¸å…¼å®¹é—®é¢˜ã€‚ 1.2. 2ã€Unsafe Apiè¿™é‡Œå¹¶ä¸"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://picsum.photos/1920/912"><meta property="article:published_time" content="2022-10-29T16:00:00.000Z"><meta property="article:modified_time" content="2023-06-13T23:32:42.670Z"><meta property="article:author" content="Taylor Luo"><meta property="article:tag" content="JavaåŸºç¡€"><meta property="article:tag" content="é›†åˆæ¡†æ¶"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://picsum.photos/1920/912"><link rel="shortcut icon" href="https://gcore.jsdelivr.net/gh/code-anan/image/èœ˜è››ç½‘ä¸‡åœ£èŠ‚.png"><link rel="canonical" href="https://taylorluo.github.io/2022/10/29/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-6%E3%80%81ConcurrentHashMap(JDK1.7)/"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!0,languages:{hits_empty:"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}"}},translate:{defaultEncoding:2,translateDelay:0,msgToTraditionalChinese:"ç¹",msgToSimplifiedChinese:"ç®€"},noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"å¤åˆ¶æˆåŠŸ",error:"å¤åˆ¶é”™è¯¯",noSupport:"æµè§ˆå™¨ä¸æ”¯æŒ"},relativeDate:{homepage:!1,post:!1},runtime:"",date_suffix:{just:"åˆšåˆš",min:"åˆ†é’Ÿå‰",hour:"å°æ—¶å‰",day:"å¤©å‰",month:"ä¸ªæœˆå‰"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!1,islazyload:!1,isAnchor:!0}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"JavaåŸºç¡€-é›†åˆæ¡†æ¶-6ã€ConcurrentHashMap(JDK1.7)",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-06-14 07:32:42"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const n=864e5*o,a={value:t,expiry:(new Date).getTime()+n};localStorage.setItem(e,JSON.stringify(a))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onerror=o,n.onload=n.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(n.onload=n.onreadystatechange=null,t())},document.head.appendChild(n)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme");"dark"===t?activateDarkMode():"light"===t&&activateLightMode();const o=saveToLocal.get("aside-status");void 0!==o&&("hide"===o?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel="stylesheet" href="/self/Kimbiedark.css"><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="Taylor" type="application/atom+xml"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">åŠ è½½ä¸­...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/index.jpeg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">183</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">85</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">31</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>åˆ†ç±»</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('https://picsum.photos/1920/912')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Taylor</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>æ—¶é—´è½´</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i> <span>æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>åˆ†ç±»</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-6ã€ConcurrentHashMap(JDK1.7)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2022-10-29T16:00:00.000Z" title="å‘è¡¨äº 2022-10-30 00:00:00">2022-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2023-06-13T23:32:42.670Z" title="æ›´æ–°äº 2023-06-14 07:32:42">2023-06-14</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/">é›†åˆæ¡†æ¶</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">2.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>13åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span data-flag-title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-6ã€ConcurrentHashMap(JDK1.7)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="twikoo_visitors"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/2022/10/29/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-6%E3%80%81ConcurrentHashMap(JDK1.7)/#post-comment"><span id="twikoo-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1-Unsafe-ä»‹ç»"><a href="#1-Unsafe-ä»‹ç»" class="headerlink" title="1. Unsafe ä»‹ç»"></a>1. Unsafe ä»‹ç»</h1><h2 id="1-1-1ã€Unsafe-ç®€ä»‹"><a href="#1-1-1ã€Unsafe-ç®€ä»‹" class="headerlink" title="1.1. 1ã€Unsafe ç®€ä»‹"></a>1.1. 1ã€Unsafe ç®€ä»‹</h2><p>Unsafe ç±»ç›¸å½“äºæ˜¯ä¸€ä¸ª java è¯­è¨€ä¸­çš„åé—¨ç±»ï¼Œ<strong>æä¾›äº†ç¡¬ä»¶çº§åˆ«çš„åŸå­æ“ä½œ</strong>ï¼Œæ‰€ä»¥åœ¨ä¸€äº›å¹¶å‘ç¼–ç¨‹ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚jdk å·²ç»ä½œå‡ºè¯´æ˜ï¼Œè¯¥ç±»å¯¹ç¨‹åºå‘˜è€Œè¨€ä¸æ˜¯ä¸€ä¸ªå®‰å…¨æ“ä½œï¼Œåœ¨åç»­çš„ jdk å‡çº§è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šç¦ç”¨è¯¥ç±»ã€‚æ‰€ä»¥è¿™ä¸ªç±»çš„ä½¿ç”¨æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ï¼Œå®é™…é¡¹ç›®ä¸­è°¨æ…ä½¿ç”¨ï¼Œä»¥å…é€ æˆ jdk å‡çº§ä¸å…¼å®¹é—®é¢˜ã€‚</p><h2 id="1-2-2ã€Unsafe-Api"><a href="#1-2-2ã€Unsafe-Api" class="headerlink" title="1.2. 2ã€Unsafe Api"></a>1.2. 2ã€Unsafe Api</h2><p>è¿™é‡Œå¹¶ä¸ç³»ç»Ÿè®²è§£ Unsafe çš„æ‰€æœ‰åŠŸèƒ½ï¼Œåªä»‹ç»å’Œæ¥ä¸‹æ¥å†…å®¹ç›¸å…³çš„æ“ä½œ</p><p><code>arrayBaseOffset</code>ï¼šè·å–æ•°ç»„çš„åŸºç¡€åç§»é‡</p><p><code>arrayIndexScale</code>ï¼šè·å–æ•°ç»„ä¸­å…ƒç´ çš„åç§»é—´éš”ï¼Œè¦è·å–å¯¹åº”æ‰€ä»¥çš„å…ƒç´ ï¼Œå°†ç´¢å¼•å·å’Œè¯¥å€¼ç›¸ä¹˜ï¼Œè·å¾—æ•°ç»„ä¸­æŒ‡å®šè§’æ ‡å…ƒç´ çš„åç§»é‡</p><p><code>getObjectVolatile</code>ï¼šè·å–å¯¹è±¡ä¸Šçš„å±æ€§å€¼æˆ–è€…æ•°ç»„ä¸­çš„å…ƒç´ </p><p><code>getObject</code>ï¼šè·å–å¯¹è±¡ä¸Šçš„å±æ€§å€¼æˆ–è€…æ•°ç»„ä¸­çš„å…ƒç´ ï¼Œå·²è¿‡æ—¶</p><p><code>putOrderedObject</code>ï¼šè®¾ç½®å¯¹è±¡çš„å±æ€§å€¼æˆ–è€…æ•°ç»„ä¸­æŸä¸ªè§’æ ‡çš„å…ƒç´ ï¼Œæ›´é«˜æ•ˆ</p><p><code>putObjectVolatile</code>ï¼šè®¾ç½®å¯¹è±¡çš„å±æ€§å€¼æˆ–è€…æ•°ç»„ä¸­æŸä¸ªè§’æ ‡çš„å…ƒç´ </p><p><code>putObject</code>ï¼šè®¾ç½®å¯¹è±¡çš„å±æ€§å€¼æˆ–è€…æ•°ç»„ä¸­æŸä¸ªè§’æ ‡çš„å…ƒç´ ï¼Œå·²è¿‡æ—¶</p><h2 id="1-3-3ã€ä»£ç æ¼”ç¤º"><a href="#1-3-3ã€ä»£ç æ¼”ç¤º" class="headerlink" title="1.3. 3ã€ä»£ç æ¼”ç¤º"></a>1.3. 3ã€ä»£ç æ¼”ç¤º</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test02</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Integer[] arr = &#123;<span class="hljs-number">2</span>,<span class="hljs-number">5</span>,<span class="hljs-number">1</span>,<span class="hljs-number">8</span>,<span class="hljs-number">10</span>&#125;;<br><br>        <span class="hljs-comment">//è·å–Unsafeå¯¹è±¡</span><br>        <span class="hljs-type">Unsafe</span> <span class="hljs-variable">unsafe</span> <span class="hljs-operator">=</span> getUnsafe();<br>        <span class="hljs-comment">//è·å–Integer[]çš„åŸºç¡€åç§»é‡</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">baseOffset</span> <span class="hljs-operator">=</span> unsafe.arrayBaseOffset(Integer[].class);<br>        <span class="hljs-comment">//è·å–Integer[]ä¸­å…ƒç´ çš„åç§»é—´éš”</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">indexScale</span> <span class="hljs-operator">=</span> unsafe.arrayIndexScale(Integer[].class);<br><br>        <span class="hljs-comment">//è·å–æ•°ç»„ä¸­ç´¢å¼•ä¸º2çš„å…ƒç´ å¯¹è±¡</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> unsafe.getObjectVolatile(arr, (<span class="hljs-number">2</span> * indexScale) + baseOffset);<br>        System.out.println(o); <span class="hljs-comment">//1</span><br><br>        <span class="hljs-comment">//è®¾ç½®æ•°ç»„ä¸­ç´¢å¼•ä¸º2çš„å…ƒç´ å€¼ä¸º100</span><br>        unsafe.putOrderedObject(arr,(<span class="hljs-number">2</span> * indexScale) + baseOffset,<span class="hljs-number">100</span>);<br><br>        System.out.println(Arrays.toString(arr));<span class="hljs-comment">//[2, 5, 100, 8, 10]</span><br>    &#125;<br><br>    <span class="hljs-comment">//åå°„è·å–Unsafeå¯¹è±¡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Unsafe <span class="hljs-title function_">getUnsafe</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">theUnsafe</span> <span class="hljs-operator">=</span> Unsafe.class.getDeclaredField(<span class="hljs-string">&quot;theUnsafe&quot;</span>);<br>        theUnsafe.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-keyword">return</span> (Unsafe) theUnsafe.get(<span class="hljs-literal">null</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20221107223658.png"></p><h1 id="2-å®¹å™¨åˆå§‹åŒ–"><a href="#2-å®¹å™¨åˆå§‹åŒ–" class="headerlink" title="2. å®¹å™¨åˆå§‹åŒ–"></a>2. å®¹å™¨åˆå§‹åŒ–</h1><h2 id="2-1-1ã€æºç åˆ†æ"><a href="#2-1-1ã€æºç åˆ†æ" class="headerlink" title="2.1. 1ã€æºç åˆ†æ"></a>2.1. 1ã€æºç åˆ†æ</h2><p>æ— å‚æ„é€ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ç©ºå‚æ„é€   </span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcurrentHashMap</span><span class="hljs-params">()</span> &#123;  <br> Â  Â <span class="hljs-comment">//è°ƒç”¨æœ¬ç±»çš„å¸¦å‚æ„é€   </span><br> Â  Â <span class="hljs-comment">//DEFAULT_INITIAL_CAPACITY = 16  </span><br> Â  Â <span class="hljs-comment">//DEFAULT_LOAD_FACTOR = 0.75f  </span><br> Â  Â <span class="hljs-comment">//int DEFAULT_CONCURRENCY_LEVEL = 16  </span><br> Â  Â <span class="hljs-built_in">this</span>(DEFAULT_INITIAL_CAPACITY, DEFAULT_LOAD_FACTOR, DEFAULT_CONCURRENCY_LEVEL);  <br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸‰ä¸ªå‚æ•°çš„æ„é€ ï¼šä¸€äº›éæ ¸å¿ƒé€»è¾‘çš„ä»£ç å·²ç»çœç•¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//initialCapacity å®šä¹‰ConcurrentHashMapå­˜æ”¾å…ƒç´ çš„å®¹é‡  </span><br><span class="hljs-comment">//concurrencyLevel å®šä¹‰ConcurrentHashMapä¸­Segment[]çš„å¤§å°  </span><br><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConcurrentHashMap</span><span class="hljs-params">(<span class="hljs-type">int</span> initialCapacity,  </span><br><span class="hljs-params"> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="hljs-type">float</span> loadFactor, <span class="hljs-type">int</span> concurrencyLevel)</span> &#123;  <br> Â    <br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">sshift</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">ssize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <br> Â  Â <span class="hljs-comment">//è®¡ç®—Segment[]çš„å¤§å°ï¼Œä¿è¯æ˜¯2çš„å¹‚æ¬¡æ–¹æ•°  </span><br> Â  Â <span class="hljs-keyword">while</span> (ssize &lt; concurrencyLevel) &#123;  <br> Â  Â  Â  Â ++sshift;  <br> Â  Â  Â  Â ssize &lt;&lt;= <span class="hljs-number">1</span>;  <br> Â   &#125;  <br> Â  Â <span class="hljs-comment">//è¿™ä¸¤ä¸ªå€¼ç”¨äºåé¢è®¡ç®—Segment[]çš„è§’æ ‡  </span><br> Â  Â <span class="hljs-built_in">this</span>.segmentShift = <span class="hljs-number">32</span> - sshift;  <br> Â  Â <span class="hljs-built_in">this</span>.segmentMask = ssize - <span class="hljs-number">1</span>;  <br> Â  Â   <br> Â  Â <span class="hljs-comment">//è®¡ç®—æ¯ä¸ªSegmentä¸­å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> initialCapacity / ssize;  <br> Â  Â <span class="hljs-keyword">if</span> (c * ssize &lt; initialCapacity)  <br> Â  Â  Â  Â ++c;  <br> Â  Â <span class="hljs-comment">//æœ€å°Segmentä¸­å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°ä¸º2  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> MIN_SEGMENT_TABLE_CAPACITY;  <br> Â  Â <span class="hljs-comment">////çŸ«æ­£æ¯ä¸ªSegmentä¸­å­˜å‚¨å…ƒç´ çš„ä¸ªæ•°ï¼Œä¿è¯æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œæœ€å°ä¸º2  </span><br> Â  Â <span class="hljs-keyword">while</span> (cap &lt; c)  <br> Â  Â  Â  Â cap &lt;&lt;= <span class="hljs-number">1</span>;  <br> Â  Â <span class="hljs-comment">//åˆ›å»ºä¸€ä¸ªSegmentå¯¹è±¡ï¼Œä½œä¸ºå…¶ä»–Segmentå¯¹è±¡çš„æ¨¡æ¿  </span><br> Â  Â Segment&lt;K,V&gt; s0 =  <br> Â  Â  Â  Â <span class="hljs-keyword">new</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt;(loadFactor, (<span class="hljs-type">int</span>)(cap * loadFactor),  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  (HashEntry&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[cap]);  <br> Â  Â Segment&lt;K,V&gt;[] ss = (Segment&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Segment</span>[ssize];  <br> Â  Â <span class="hljs-comment">//åˆ©ç”¨Unsafeç±»ï¼Œå°†åˆ›å»ºçš„Segmentå¯¹è±¡å­˜å…¥0è§’æ ‡ä½ç½®  </span><br> Â  Â UNSAFE.putOrderedObject(ss, SBASE, s0); <span class="hljs-comment">// ordered write of segments[0]  </span><br> Â  Â <span class="hljs-built_in">this</span>.segments = ss;  <br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼šConcurrentHashMap ä¸­ä¿å­˜äº†ä¸€ä¸ª **é»˜è®¤é•¿åº¦ä¸º 16 çš„ <code>Segment[]</code>**ï¼Œæ¯ä¸ª Segment å…ƒç´ ä¸­ä¿å­˜äº†ä¸€ä¸ª **é»˜è®¤é•¿åº¦ä¸º 2 çš„ <code>HashEntry[]</code>**ï¼Œæˆ‘ä»¬æ·»åŠ çš„å…ƒç´ ï¼Œæ˜¯å­˜å…¥å¯¹åº”çš„ Segment ä¸­çš„ <code>HashEntry[]</code> ä¸­ã€‚æ‰€ä»¥ ConcurrentHashMap ä¸­<span style="background-color:red">é»˜è®¤å…ƒç´ çš„é•¿åº¦æ˜¯ 32 ä¸ªï¼Œè€Œä¸æ˜¯ 16 ä¸ª</span></p><h2 id="2-2-2ã€ä¸¤ä¸ªæ•°ç»„"><a href="#2-2-2ã€ä¸¤ä¸ªæ•°ç»„" class="headerlink" title="2.2. 2ã€ä¸¤ä¸ªæ•°ç»„"></a>2.2. 2ã€ä¸¤ä¸ªæ•°ç»„</h2><p><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20221107224218.png"></p><h3 id="2-2-1-Segment-extends-ReentrantLockâ­ï¸ğŸ”´"><a href="#2-2-1-Segment-extends-ReentrantLockâ­ï¸ğŸ”´" class="headerlink" title="2.2.1. Segment-extends ReentrantLockâ­ï¸ğŸ”´"></a>2.2.1. Segment-extends ReentrantLockâ­ï¸ğŸ”´</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ReentrantLock</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;  <br>  ...  <br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>æˆ‘ä»¬å‘ç° <span style="background-color:red">Segment æ˜¯ç»§æ‰¿è‡ª ReentrantLock</span> çš„ï¼Œå­¦è¿‡çº¿ç¨‹çš„å…„å¼Ÿéƒ½çŸ¥é“ï¼Œå®ƒå¯ä»¥å®ç°åŒæ­¥æ“ä½œï¼Œä»è€Œä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨ã€‚å› ä¸ºæ¯ä¸ª Segment ä¹‹é—´çš„é”äº’ä¸å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå°† ConcurrentHashMap ä¸­çš„è¿™ç§é”æœºåˆ¶ç§°ä¹‹ä¸º <strong>åˆ†æ®µé”</strong>ï¼Œè¿™æ¯” HashTable çš„çº¿ç¨‹å®‰å…¨æ“ä½œé«˜æ•ˆçš„å¤šã€‚</p></blockquote><h3 id="2-2-2-HashEntry"><a href="#2-2-2-HashEntry" class="headerlink" title="2.2.2. HashEntry"></a>2.2.2. HashEntry</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ConcurrentHashMapä¸­çœŸæ­£å­˜å‚¨æ•°æ®çš„å¯¹è±¡  </span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt; &#123;  <br> Â  Â <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> hash; <span class="hljs-comment">//é€šè¿‡è¿ç®—ï¼Œå¾—åˆ°çš„é”®çš„hashå€¼  </span><br> Â  Â <span class="hljs-keyword">final</span> K key; <span class="hljs-comment">// å­˜å…¥çš„é”®  </span><br> Â  Â <span class="hljs-keyword">volatile</span> V value; <span class="hljs-comment">//å­˜å…¥çš„å€¼  </span><br> Â  Â <span class="hljs-keyword">volatile</span> HashEntry&lt;K,V&gt; next; <span class="hljs-comment">//è®°å½•ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå½¢æˆå•å‘é“¾è¡¨  </span><br>â€‹  <br> Â  Â HashEntry(<span class="hljs-type">int</span> hash, K key, V value, HashEntry&lt;K,V&gt; next) &#123;  <br> Â  Â  Â  Â <span class="hljs-built_in">this</span>.hash = hash;  <br> Â  Â  Â  Â <span class="hljs-built_in">this</span>.key = key;  <br> Â  Â  Â  Â <span class="hljs-built_in">this</span>.value = value;  <br> Â  Â  Â  Â <span class="hljs-built_in">this</span>.next = next;  <br> Â   &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3-æ·»åŠ å®‰å…¨â­ï¸ğŸ”´"><a href="#3-æ·»åŠ å®‰å…¨â­ï¸ğŸ”´" class="headerlink" title="3. æ·»åŠ å®‰å…¨â­ï¸ğŸ”´"></a>3. æ·»åŠ å®‰å…¨â­ï¸ğŸ”´</h1><p><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20230523073444.png" alt="image.png"></p><h2 id="3-1-ConcurrentHashMap-çš„-put-æ–¹æ³•"><a href="#3-1-ConcurrentHashMap-çš„-put-æ–¹æ³•" class="headerlink" title="3.1. ConcurrentHashMap çš„ put æ–¹æ³•"></a>3.1. ConcurrentHashMap çš„ put æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;  <br> Â  Â Segment&lt;K,V&gt; s;  <br> Â  Â <span class="hljs-keyword">if</span> (value == <span class="hljs-literal">null</span>)  <br> Â  Â  Â  Â <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>();  <br> Â  Â <span class="hljs-comment">//åŸºäºkeyï¼Œè®¡ç®—hashå€¼  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);  <br> Â  Â <span class="hljs-comment">//å› ä¸ºä¸€ä¸ªé”®è¦è®¡ç®—ä¸¤ä¸ªæ•°ç»„çš„ç´¢å¼•ï¼Œä¸ºäº†é¿å…å†²çªï¼Œè¿™é‡Œå–é«˜ä½è®¡ç®—Segment[]çš„ç´¢å¼•  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> (hash &gt;&gt;&gt; segmentShift) &amp; segmentMask;  <br> Â  Â <span class="hljs-comment">//åˆ¤æ–­è¯¥ç´¢å¼•ä½çš„Segmentå¯¹è±¡æ˜¯å¦åˆ›å»ºï¼Œæ²¡æœ‰å°±åˆ›å»º  </span><br> Â  Â <span class="hljs-keyword">if</span> ((s = (Segment&lt;K,V&gt;)UNSAFE.getObject Â  Â  Â  Â  Â <span class="hljs-comment">// nonvolatile; recheck  </span><br> Â  Â  Â  Â  (segments, (j &lt;&lt; SSHIFT) + SBASE)) == <span class="hljs-literal">null</span>) <span class="hljs-comment">//  in ensureSegment  </span><br> Â  Â  Â  Â s = ensureSegment(j);  <br> Â  Â <span class="hljs-comment">//è°ƒç”¨Segmetnçš„putæ–¹æ³•å®ç°å…ƒç´ æ·»åŠ   </span><br> Â  Â <span class="hljs-keyword">return</span> s.put(key, hash, value, <span class="hljs-literal">false</span>);  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-2-ConcurrentHashMap-çš„-ensureSegment-æ–¹æ³•"><a href="#3-2-ConcurrentHashMap-çš„-ensureSegment-æ–¹æ³•" class="headerlink" title="3.2. ConcurrentHashMap çš„ ensureSegment æ–¹æ³•"></a>3.2. ConcurrentHashMap çš„ ensureSegment æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//åˆ›å»ºå¯¹åº”ç´¢å¼•ä½çš„Segmentå¯¹è±¡ï¼Œå¹¶è¿”å›  </span><br><span class="hljs-keyword">private</span> Segment&lt;K,V&gt; <span class="hljs-title function_">ensureSegment</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span> &#123;  <br> Â  Â <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] ss = <span class="hljs-built_in">this</span>.segments;  <br> Â  Â <span class="hljs-type">long</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (k &lt;&lt; SSHIFT) + SBASE; <span class="hljs-comment">// raw offset  </span><br> Â  Â Segment&lt;K,V&gt; seg;  <br> Â  Â <span class="hljs-comment">//è·å–ï¼Œå¦‚æœä¸ºnullï¼Œå³åˆ›å»º  </span><br> Â  Â <span class="hljs-keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u)) == <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â <span class="hljs-comment">//ä»¥0è§’æ ‡ä½çš„Segmentä¸ºæ¨¡æ¿  </span><br> Â  Â  Â  Â Segment&lt;K,V&gt; proto = ss[<span class="hljs-number">0</span>]; <span class="hljs-comment">// use segment 0 as prototype  </span><br> Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> proto.table.length;  <br> Â  Â  Â  Â <span class="hljs-type">float</span> <span class="hljs-variable">lf</span> <span class="hljs-operator">=</span> proto.loadFactor;  <br> Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">threshold</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)(cap * lf);  <br> Â  Â  Â  Â HashEntry&lt;K,V&gt;[] tab = (HashEntry&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[cap];  <br> Â  Â  Â  Â <span class="hljs-comment">//è·å–ï¼Œå¦‚æœä¸ºnullï¼Œå³åˆ›å»º  </span><br> Â  Â  Â  Â <span class="hljs-keyword">if</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))  <br> Â  Â  Â  Â  Â  Â == <span class="hljs-literal">null</span>) &#123; <span class="hljs-comment">// recheck  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//åˆ›å»º  </span><br> Â  Â  Â  Â  Â  Â Segment&lt;K,V&gt; s = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Segment</span>&lt;K,V&gt;(lf, threshold, tab);  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//è‡ªæ—‹æ–¹å¼ï¼Œå°†åˆ›å»ºçš„Segmentå¯¹è±¡æ”¾åˆ°Segment[]ä¸­ï¼Œç¡®ä¿çº¿ç¨‹å®‰å…¨  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">while</span> ((seg = (Segment&lt;K,V&gt;)UNSAFE.getObjectVolatile(ss, u))  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  == <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (UNSAFE.compareAndSwapObject(ss, u, <span class="hljs-literal">null</span>, seg = s))  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;  <br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â   &#125;  <br> Â   &#125;  <br> Â  Â <span class="hljs-comment">//è¿”å›  </span><br> Â  Â <span class="hljs-keyword">return</span> seg;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-Segment-çš„-put-æ–¹æ³•"><a href="#3-3-Segment-çš„-put-æ–¹æ³•" class="headerlink" title="3.3. Segment çš„ put æ–¹æ³•"></a>3.3. Segment çš„ put æ–¹æ³•</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, <span class="hljs-type">int</span> hash, V value, <span class="hljs-type">boolean</span> onlyIfAbsent)</span> &#123;  <br> Â  Â <span class="hljs-comment">//å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸï¼Œnodeä¸ºnullï¼Œä»£ç å‘ä¸‹æ‰§è¡Œ  </span><br> Â  Â <span class="hljs-comment">//å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å æ®é”å¯¹è±¡ï¼Œé‚£ä¹ˆå»åšåˆ«çš„äº‹æƒ…ï¼Œè€Œä¸æ˜¯ä¸€ç›´ç­‰å¾…ï¼Œæå‡æ•ˆç‡  </span><br> Â  Â <span class="hljs-comment">//scanAndLockForPut ç¨ååˆ†æ  </span><br> Â  Â HashEntry&lt;K,V&gt; node = tryLock() ? <span class="hljs-literal">null</span> :  <br> Â  Â  Â  Â scanAndLockForPut(key, hash, value);  <br> Â  Â V oldValue;  <br> Â  Â <span class="hljs-keyword">try</span> &#123;  <br> Â  Â  Â  Â HashEntry&lt;K,V&gt;[] tab = table;  <br> Â  Â  Â  Â <span class="hljs-comment">//å–hashçš„ä½ä½ï¼Œè®¡ç®—HashEntry[]çš„ç´¢å¼•  </span><br> Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> (tab.length - <span class="hljs-number">1</span>) &amp; hash;  <br> Â  Â  Â  Â <span class="hljs-comment">//è·å–ç´¢å¼•ä½çš„å…ƒç´ å¯¹è±¡  </span><br> Â  Â  Â  Â HashEntry&lt;K,V&gt; first = entryAt(tab, index);  <br> Â  Â  Â  Â <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; e = first;;) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//è·å–çš„å…ƒç´ å¯¹è±¡ä¸ä¸ºç©º  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â K k;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœæ˜¯é‡å¤å…ƒç´ ï¼Œè¦†ç›–åŸå€¼  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> ((k = e.key) == key ||  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â   (e.hash == hash &amp;&amp; key.equals(k))) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â oldValue = e.value;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (!onlyIfAbsent) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â e.value = value;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ++modCount;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;  <br> Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœä¸æ˜¯é‡å¤å…ƒç´ ï¼Œè·å–é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œç»§ç»­å¾ªç¯éå†é“¾è¡¨  </span><br> Â  Â  Â  Â  Â  Â  Â  Â e = e.next;  <br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">//å¦‚æœè·å–åˆ°çš„å…ƒç´ ä¸ºç©º  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å½“å‰æ·»åŠ çš„é”®å€¼å¯¹çš„HashEntryå¯¹è±¡å·²ç»åˆ›å»º  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (node != <span class="hljs-literal">null</span>)  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â node.setNext(first); <span class="hljs-comment">//å¤´æ’æ³•å…³è”å³å¯  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span>  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//åˆ›å»ºå½“å‰æ·»åŠ çš„é”®å€¼å¯¹çš„HashEntryå¯¹è±¡  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, first);  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//æ·»åŠ çš„å…ƒç´ æ•°é‡é€’å¢  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> count + <span class="hljs-number">1</span>;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (c &gt; threshold &amp;&amp; tab.length &lt; MAXIMUM_CAPACITY)  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//éœ€è¦æ‰©å®¹  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â rehash(node);  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span>  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//ä¸éœ€è¦æ‰©å®¹  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å°†å½“å‰æ·»åŠ çš„å…ƒç´ å¯¹è±¡ï¼Œå­˜å…¥æ•°ç»„è§’æ ‡ä½ï¼Œå®Œæˆå¤´æ’æ³•æ·»åŠ å…ƒç´   </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setEntryAt(tab, index, node);  <br> Â  Â  Â  Â  Â  Â  Â  Â ++modCount;  <br> Â  Â  Â  Â  Â  Â  Â  Â count = c;  <br> Â  Â  Â  Â  Â  Â  Â  Â oldValue = <span class="hljs-literal">null</span>;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;  <br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â   &#125;  <br> Â   &#125; <span class="hljs-keyword">finally</span> &#123;  <br> Â  Â  Â  Â <span class="hljs-comment">//é‡Šæ”¾é”  </span><br> Â  Â  Â  Â unlock();  <br> Â   &#125;  <br> Â  Â <span class="hljs-keyword">return</span> oldValue;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-4-Segment-çš„-scanAndLockForPut-æ–¹æ³•"><a href="#3-4-Segment-çš„-scanAndLockForPut-æ–¹æ³•" class="headerlink" title="3.4. Segment çš„ scanAndLockForPut æ–¹æ³•"></a>3.4. Segment çš„ scanAndLockForPut æ–¹æ³•</h2><p>è¯¥æ–¹æ³•åœ¨çº¿ç¨‹æ²¡æœ‰è·å–åˆ°é”çš„æƒ…å†µä¸‹ï¼Œå»å®Œæˆ HashEntry å¯¹è±¡çš„åˆ›å»ºï¼Œæå‡æ•ˆç‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> HashEntry&lt;K,V&gt; <span class="hljs-title function_">scanAndLockForPut</span><span class="hljs-params">(K key, <span class="hljs-type">int</span> hash, V value)</span> &#123;  <br> Â  Â <span class="hljs-comment">//è·å–å¤´éƒ¨å…ƒç´   </span><br> Â  Â HashEntry&lt;K,V&gt; first = entryForHash(<span class="hljs-built_in">this</span>, hash);  <br> Â  Â HashEntry&lt;K,V&gt; e = first;  <br> Â  Â HashEntry&lt;K,V&gt; node = <span class="hljs-literal">null</span>ï¼›  <br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// negative while locating node  </span><br> Â  Â <span class="hljs-keyword">while</span> (!tryLock()) &#123;  <br> Â  Â  Â  Â <span class="hljs-comment">//è·å–é”å¤±è´¥  </span><br> Â  Â  Â  Â HashEntry&lt;K,V&gt; f; <span class="hljs-comment">// to recheck first below  </span><br> Â  Â  Â  Â <span class="hljs-keyword">if</span> (retries &lt; <span class="hljs-number">0</span>) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//æ²¡æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¹Ÿä¸æ˜¯é‡å¤å…ƒç´ ï¼Œåˆ›å»ºHashEntryå¯¹è±¡ï¼Œä¸å†éå†  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (e == <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (node == <span class="hljs-literal">null</span>) <span class="hljs-comment">// speculatively create node  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â node = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(hash, key, value, <span class="hljs-literal">null</span>);  <br> Â  Â  Â  Â  Â  Â  Â  Â retries = <span class="hljs-number">0</span>;  <br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (key.equals(e.key))  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//é‡å¤å…ƒç´ ï¼Œä¸åˆ›å»ºHashEntryå¯¹è±¡ï¼Œä¸å†éå†  </span><br> Â  Â  Â  Â  Â  Â  Â  Â retries = <span class="hljs-number">0</span>;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span>  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//ç»§ç»­éå†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹  </span><br> Â  Â  Â  Â  Â  Â  Â  Â e = e.next;  <br> Â  Â  Â   &#125;  <br> Â  Â  Â  Â <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (++retries &gt; MAX_SCAN_RETRIES) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœå°è¯•è·å–é”çš„æ¬¡æ•°è¿‡å¤šï¼Œç›´æ¥é˜»å¡  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//MAX_SCAN_RETRIESä¼šæ ¹æ®å¯ç”¨cpuæ ¸æ•°æ¥ç¡®å®š  </span><br> Â  Â  Â  Â  Â  Â lock();  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;  <br> Â  Â  Â   &#125;  <br> Â  Â  Â  Â <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((retries &amp; <span class="hljs-number">1</span>) == <span class="hljs-number">0</span> &amp;&amp;  <br> Â  Â  Â  Â  Â  Â  Â  Â  (f = entryForHash(<span class="hljs-built_in">this</span>, hash)) != first) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœæœŸé—´æœ‰åˆ«çš„çº¿ç¨‹è·å–é”ï¼Œé‡æ–°éå†  </span><br> Â  Â  Â  Â  Â  Â e = first = f; <span class="hljs-comment">// re-traverse if entry changed  </span><br> Â  Â  Â  Â  Â  Â retries = -<span class="hljs-number">1</span>;  <br> Â  Â  Â   &#125;  <br> Â   &#125;  <br> Â  Â <span class="hljs-keyword">return</span> node;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-5-æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„ä»£ç æµç¨‹"><a href="#3-5-æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„ä»£ç æµç¨‹" class="headerlink" title="3.5. æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„ä»£ç æµç¨‹"></a>3.5. æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„ä»£ç æµç¨‹</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;  <br> Â  Â <span class="hljs-keyword">final</span> <span class="hljs-type">ConcurrentHashMap</span> <span class="hljs-variable">chm</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentHashMap</span>();  <br><br> Â  Â <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;  <br> Â  Â  Â  Â <span class="hljs-meta">@Override</span>  <br> Â  Â  Â  Â <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;  <br> Â  Â  Â  Â  Â  Â chm.put(<span class="hljs-string">&quot;é€šè¯&quot;</span>,<span class="hljs-string">&quot;11&quot;</span>);  <br> Â  Â  Â  Â  Â  Â System.out.println(<span class="hljs-string">&quot;-----------&quot;</span>);  <br> Â  Â  Â   &#125;  <br> Â   &#125;.start();  <br><br>  <span class="hljs-comment">//è®©ç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆå¯åŠ¨ï¼Œè¿›å…¥putæ–¹æ³•  </span><br> Â  Â Thread.sleep(<span class="hljs-number">1000</span>);  <br><br> Â  Â <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>()&#123;  <br> Â  Â  Â  Â <span class="hljs-meta">@Override</span>  <br> Â  Â  Â  Â <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;  <br> Â  Â  Â  Â  Â  Â chm.put(<span class="hljs-string">&quot;é‡åœ°&quot;</span>,<span class="hljs-string">&quot;22&quot;</span>);  <br> Â  Â  Â  Â  Â  Â System.out.println(<span class="hljs-string">&quot;===========&quot;</span>);  <br> Â  Â  Â   &#125;  <br> Â   &#125;.start();  <br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-5-1-æµç¨‹å›¾"><a href="#3-5-1-æµç¨‹å›¾" class="headerlink" title="3.5.1. æµç¨‹å›¾"></a>3.5.1. æµç¨‹å›¾</h3><p><a target="_blank" rel="noopener" href="https://www.processon.com/view/link/636a079b1efad40cd880e4fc">https://www.processon.com/view/link/636a079b1efad40cd880e4fc</a></p><h1 id="4-æ‰©å®¹å®‰å…¨"><a href="#4-æ‰©å®¹å®‰å…¨" class="headerlink" title="4. æ‰©å®¹å®‰å…¨"></a>4. æ‰©å®¹å®‰å…¨</h1><h2 id="4-1-æºç åˆ†æ"><a href="#4-1-æºç åˆ†æ" class="headerlink" title="4.1. æºç åˆ†æ"></a>4.1. æºç åˆ†æ</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">rehash</span><span class="hljs-params">(HashEntry&lt;K,V&gt; node)</span> &#123;  <br> Â  Â HashEntry&lt;K,V&gt;[] oldTable = table;  <br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">oldCapacity</span> <span class="hljs-operator">=</span> oldTable.length;  <br> Â  Â <span class="hljs-comment">//ä¸¤å€å®¹é‡  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">newCapacity</span> <span class="hljs-operator">=</span> oldCapacity &lt;&lt; <span class="hljs-number">1</span>;  <br> Â  Â threshold = (<span class="hljs-type">int</span>)(newCapacity * loadFactor);  <br> Â  Â <span class="hljs-comment">//åŸºäºæ–°å®¹é‡ï¼Œåˆ›å»ºHashEntryæ•°ç»„  </span><br> Â  Â HashEntry&lt;K,V&gt;[] newTable =  <br> Â  Â  Â   (HashEntry&lt;K,V&gt;[]) <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>[newCapacity];  <br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">sizeMask</span> <span class="hljs-operator">=</span> newCapacity - <span class="hljs-number">1</span>;  <br> Â   <span class="hljs-comment">//å®ç°æ•°æ®è¿ç§»  </span><br> Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; oldCapacity ; i++) &#123;  <br> Â  Â  Â  Â HashEntry&lt;K,V&gt; e = oldTable[i];  <br> Â  Â  Â  Â <span class="hljs-keyword">if</span> (e != <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â  Â  Â HashEntry&lt;K,V&gt; next = e.next;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> e.hash &amp; sizeMask;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (next == <span class="hljs-literal">null</span>) Â  <span class="hljs-comment">//  Single node on list  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//åŸä½ç½®åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œç›´æ¥æ”¾åˆ°æ–°æ•°ç»„å³å¯  </span><br> Â  Â  Â  Â  Â  Â  Â  Â newTable[idx] = e;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// Reuse consecutive sequence at same slot  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾ä¸€=====================  </span><br> Â  Â  Â  Â  Â  Â  Â  Â HashEntry&lt;K,V&gt; lastRun = e;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">lastIdx</span> <span class="hljs-operator">=</span> idx;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; last = next;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last != <span class="hljs-literal">null</span>;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  last = last.next) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> last.hash &amp; sizeMask;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (k != lastIdx) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lastIdx = k;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â lastRun = last;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾ä¸€=====================  </span><br> Â  Â  Â  Â  Â  Â  Â  Â   <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾äºŒ=====================  </span><br> Â  Â  Â  Â  Â  Â  Â  Â newTable[lastIdx] = lastRun;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾äºŒ=====================  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">// Clone remaining nodes  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾ä¸‰=====================  </span><br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (HashEntry&lt;K,V&gt; p = e; p != lastRun; p = p.next) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">V</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> p.value;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> p.hash;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">k</span> <span class="hljs-operator">=</span> h &amp; sizeMask;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â HashEntry&lt;K,V&gt; n = newTable[k];  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//è¿™é‡Œæ—§çš„HashEntryä¸ä¼šæ”¾åˆ°æ–°æ•°ç»„  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//è€Œæ˜¯åŸºäºåŸæ¥çš„æ•°æ®åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„HashEntryå¯¹è±¡ï¼Œæ”¾å…¥æ–°æ•°ç»„  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â newTable[k] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashEntry</span>&lt;K,V&gt;(h, p.key, v, n);  <br> Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//=========å›¾ä¸‰=====================  </span><br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â   &#125;  <br> Â   &#125;  <br> Â  Â <span class="hljs-comment">//é‡‡ç”¨å¤´æ’æ³•ï¼Œå°†æ–°å…ƒç´ åŠ å…¥åˆ°æ•°ç»„ä¸­  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">nodeIndex</span> <span class="hljs-operator">=</span> node.hash &amp; sizeMask; <span class="hljs-comment">// add the new node  </span><br> Â  Â node.setNext(newTable[nodeIndex]);  <br> Â  Â newTable[nodeIndex] = node;  <br> Â  Â table = newTable;  <br>&#125;<br></code></pre></td></tr></table></figure><p>æ—¢æœ‰ä¸²ç‰‡æ®µçš„é‡å®šå‘åˆ°æ–°æ•°ç»„ï¼Œä¹Ÿæœ‰å¤åˆ¶å…ƒç´ åˆ°æ–°æ•°ç»„</p><blockquote><p>å›¾ä¸€<br><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20221107225548.png"></p></blockquote><blockquote><p>å›¾äºŒ<br><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20221107225626.png"></p></blockquote><blockquote><p>å›¾ä¸‰<br><img src="https://raw.githubusercontent.com/TaylorLuo/typora-imgs/master/img20221107225634.png"></p></blockquote><h1 id="5-é›†åˆé•¿åº¦è·å–"><a href="#5-é›†åˆé•¿åº¦è·å–" class="headerlink" title="5. é›†åˆé•¿åº¦è·å–"></a>5. é›†åˆé•¿åº¦è·å–</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> &#123;  <br> Â  Â <span class="hljs-comment">// Try a few times to get accurate count. On failure due to  </span><br> Â  Â <span class="hljs-comment">// continuous async changes in table, resort to locking.  </span><br> Â  Â <span class="hljs-keyword">final</span> Segment&lt;K,V&gt;[] segments = <span class="hljs-built_in">this</span>.segments;  <br> Â  Â <span class="hljs-type">int</span> size;  <br> Â  Â <span class="hljs-type">boolean</span> overflow; <span class="hljs-comment">// true if size overflows 32 bits  </span><br> Â  Â <span class="hljs-type">long</span> sum; Â  Â  Â  Â  <span class="hljs-comment">// sum of modCounts  </span><br> Â  Â <span class="hljs-type">long</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> <span class="hljs-number">0L</span>; Â  <span class="hljs-comment">// previous sum  </span><br> Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">retries</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>; <span class="hljs-comment">// first iteration isn&#x27;t retry  </span><br> Â  Â <span class="hljs-keyword">try</span> &#123;  <br> Â  Â  Â  Â <span class="hljs-keyword">for</span> (;;) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å½“ç¬¬5æ¬¡èµ°åˆ°è¿™ä¸ªåœ°æ–¹æ—¶ï¼Œä¼šå°†æ•´ä¸ªSegment[]çš„æ‰€æœ‰Segmentå¯¹è±¡é”ä½  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (retries++ == RETRIES_BEFORE_LOCK) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ensureSegment(j).lock(); <span class="hljs-comment">// force creation  </span><br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â sum = <span class="hljs-number">0L</span>;  <br> Â  Â  Â  Â  Â  Â size = <span class="hljs-number">0</span>;  <br> Â  Â  Â  Â  Â  Â overflow = <span class="hljs-literal">false</span>;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â Segment&lt;K,V&gt; seg = segmentAt(segments, j);  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (seg != <span class="hljs-literal">null</span>) &#123;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//ç´¯åŠ æ‰€æœ‰Segmentçš„æ“ä½œæ¬¡æ•°  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â sum += seg.modCount;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-type">int</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> seg.count;  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-comment">//ç´¯åŠ æ‰€æœ‰segmentä¸­çš„å…ƒç´ ä¸ªæ•° size+=c  </span><br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (c &lt; <span class="hljs-number">0</span> || (size += c) &lt; <span class="hljs-number">0</span>)  <br> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â overflow = <span class="hljs-literal">true</span>;  <br> Â  Â  Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â   &#125;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//å½“è¿™æ¬¡ç´¯åŠ å€¼å’Œä¸Šä¸€æ¬¡ç´¯åŠ å€¼ä¸€æ ·ï¼Œè¯æ˜æ²¡æœ‰è¿›è¡Œæ–°çš„å¢åˆ æ”¹æ“ä½œï¼Œè¿”å›sum  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//ç¬¬ä¸€æ¬¡lastä¸º0ï¼Œå¦‚æœæœ‰å…ƒç´ çš„è¯ï¼Œè¿™ä¸ªforå¾ªç¯æœ€å°‘å¾ªç¯ä¸¤æ¬¡çš„  </span><br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">if</span> (sum == last)  <br> Â  Â  Â  Â  Â  Â  Â  Â <span class="hljs-keyword">break</span>;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-comment">//è®°å½•ç´¯åŠ çš„å€¼  </span><br> Â  Â  Â  Â  Â  Â last = sum;  <br> Â  Â  Â   &#125;  <br> Â   &#125; <span class="hljs-keyword">finally</span> &#123;  <br> Â  Â  Â  Â <span class="hljs-comment">//å¦‚æœä¹‹å‰æœ‰é”ä½ï¼Œè§£é”  </span><br> Â  Â  Â  Â <span class="hljs-keyword">if</span> (retries &gt; RETRIES_BEFORE_LOCK) &#123;  <br> Â  Â  Â  Â  Â  Â <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; segments.length; ++j)  <br> Â  Â  Â  Â  Â  Â  Â  Â segmentAt(segments, j).unlock();  <br> Â  Â  Â   &#125;  <br> Â   &#125;  <br> Â  Â <span class="hljs-comment">//æº¢å‡ºï¼Œè¿”å›intçš„æœ€å¤§å€¼ï¼Œå¦åˆ™è¿”å›ç´¯åŠ çš„size  </span><br> Â  Â <span class="hljs-keyword">return</span> overflow ? Integer.MAX_VALUE : size;  <br>&#125;<br></code></pre></td></tr></table></figure><h1 id="6-å‚è€ƒ"><a href="#6-å‚è€ƒ" class="headerlink" title="6. å‚è€ƒ"></a>6. å‚è€ƒ</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV17i4y1x71z/?from=search&amp;seid=3516507855592185473&amp;spm_id_from=333.337.0.0&amp;vd_source=c5b2d0d7bc377c0c35dbc251d95cf204">https://www.bilibili.com/video/BV17i4y1x71z/?from=search&amp;seid=3516507855592185473&amp;spm_id_from=333.337.0.0&amp;vd_source=c5b2d0d7bc377c0c35dbc251d95cf204</a><br>&#x2F;Users&#x2F;taylor&#x2F;Nutstore Files&#x2F;Obsidian_data&#x2F;pages&#x2F;002-schdule&#x2F;001-Arch&#x2F;001-Subject&#x2F;001- åŸºç¡€çŸ¥è¯†ä¸“é¢˜&#x2F;001- é›†åˆæ¡†æ¶&#x2F;ConcurrentHashMap</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…:</span> <span class="post-copyright-info"><a href="https://taylorluo.github.io">Taylor Luo</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥:</span> <span class="post-copyright-info"><a href="https://taylorluo.github.io/2022/10/29/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-6%E3%80%81ConcurrentHashMap(JDK1.7)/">https://taylorluo.github.io/2022/10/29/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-6%E3%80%81ConcurrentHashMap(JDK1.7)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜:</span> <span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://taylorluo.github.io" target="_blank">Taylor</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java%E5%9F%BA%E7%A1%80/">JavaåŸºç¡€</a><a class="post-meta__tags" href="/tags/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/">é›†åˆæ¡†æ¶</a></div><div class="post_share"><div class="social-share" data-image="https://picsum.photos/1920/912" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> æ‰“èµ</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="å¾®ä¿¡"></a><div class="post-qr-code-desc">å¾®ä¿¡</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="æ”¯ä»˜å®"></a><div class="post-qr-code-desc">æ”¯ä»˜å®</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/11/06/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-7%E3%80%81ConcurrentHashMap(JDK1.8)/"><img class="prev-cover" src="https://picsum.photos/1920/942" onerror='onerror=null,src="/null"' alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">JavaåŸºç¡€-é›†åˆæ¡†æ¶-7ã€ConcurrentHashMap(JDK1.8)</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/25/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E5%85%B3%E9%94%AE%E5%AD%97%E5%92%8C%E6%8E%A5%E5%8F%A3-1%E3%80%81Serializable%E6%8E%A5%E5%8F%A3/"><img class="next-cover" src="https://picsum.photos/1920/952" onerror='onerror=null,src="/null"' alt="cover of next post"><div class="pagination-info"><div class="label">ä¸‹ä¸€ç¯‡</div><div class="next_info">001-åŸºç¡€çŸ¥è¯†ä¸“é¢˜--å…³é”®å­—å’Œæ¥å£-1ã€Serializableæ¥å£</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><div><a href="/2022/10/23/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-1%E3%80%81%E9%9B%86%E5%90%88%E5%85%B3%E7%B3%BB%E5%8F%8A%E6%A6%82%E5%BF%B5/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-1ã€é›†åˆå…³ç³»åŠæ¦‚å¿µ"><img class="cover" src="https://picsum.photos/1920/982" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-24</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-1ã€é›†åˆå…³ç³»åŠæ¦‚å¿µ</div></div></a></div><div><a href="/2022/10/22/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-3%E3%80%81ArrayList/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-3ã€ArrayList"><img class="cover" src="https://picsum.photos/1920/992" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-23</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-3ã€ArrayList</div></div></a></div><div><a href="/2022/10/25/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-4%E3%80%81LinkedList/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-4ã€LinkedList"><img class="cover" src="https://picsum.photos/1920/962" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-26</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-4ã€LinkedList</div></div></a></div><div><a href="/2022/11/06/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-8%E3%80%81HashMap%E7%89%88%E6%9C%AC%E5%8F%98%E5%8C%96/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-8ã€HashMapç‰ˆæœ¬å˜åŒ–"><img class="cover" src="https://picsum.photos/1920/912" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-8ã€HashMapç‰ˆæœ¬å˜åŒ–</div></div></a></div><div><a href="/2022/11/06/001-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B8%93%E9%A2%98/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-9%E3%80%81%E9%9B%86%E5%90%88%E9%9D%A2%E8%AF%95%E9%A2%98/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-9ã€é›†åˆé¢è¯•é¢˜"><img class="cover" src="https://picsum.photos/1920/912" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-07</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-9ã€é›†åˆé¢è¯•é¢˜</div></div></a></div><div><a href="/2022/10/22/012-%E7%BB%8F%E9%AA%8C%E4%B8%93%E9%A2%98/Java%E5%9F%BA%E7%A1%80-%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6-2%E3%80%81%E9%9B%86%E5%90%88%E7%B1%BB%E7%9A%84%E5%9D%91/" title="JavaåŸºç¡€-é›†åˆæ¡†æ¶-2ã€é›†åˆç±»çš„å‘"><img class="cover" src="https://unpkg.com/justlovesmile-img/cover8.JPG" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-23</div><div class="title">JavaåŸºç¡€-é›†åˆæ¡†æ¶-2ã€é›†åˆç±»çš„å‘</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/index.jpeg" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">Taylor Luo</div><div class="author-info__description">äººç”Ÿæµ·æµ· ä¸å¿˜åˆå¿ƒ</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">183</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">85</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">31</div></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Unsafe-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1. Unsafe ä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-1%E3%80%81Unsafe-%E7%AE%80%E4%BB%8B"><span class="toc-text">1.1. 1ã€Unsafe ç®€ä»‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-2%E3%80%81Unsafe-Api"><span class="toc-text">1.2. 2ã€Unsafe Api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-3-3%E3%80%81%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA"><span class="toc-text">1.3. 3ã€ä»£ç æ¼”ç¤º</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-%E5%AE%B9%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-text">2. å®¹å™¨åˆå§‹åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-1%E3%80%81%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">2.1. 1ã€æºç åˆ†æ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-2%E3%80%81%E4%B8%A4%E4%B8%AA%E6%95%B0%E7%BB%84"><span class="toc-text">2.2. 2ã€ä¸¤ä¸ªæ•°ç»„</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-1-Segment-extends-ReentrantLock%E2%AD%90%EF%B8%8F%F0%9F%94%B4"><span class="toc-text">2.2.1. Segment-extends ReentrantLockâ­ï¸ğŸ”´</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-2-HashEntry"><span class="toc-text">2.2.2. HashEntry</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-%E6%B7%BB%E5%8A%A0%E5%AE%89%E5%85%A8%E2%AD%90%EF%B8%8F%F0%9F%94%B4"><span class="toc-text">3. æ·»åŠ å®‰å…¨â­ï¸ğŸ”´</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-ConcurrentHashMap-%E7%9A%84-put-%E6%96%B9%E6%B3%95"><span class="toc-text">3.1. ConcurrentHashMap çš„ put æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-ConcurrentHashMap-%E7%9A%84-ensureSegment-%E6%96%B9%E6%B3%95"><span class="toc-text">3.2. ConcurrentHashMap çš„ ensureSegment æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-Segment-%E7%9A%84-put-%E6%96%B9%E6%B3%95"><span class="toc-text">3.3. Segment çš„ put æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-Segment-%E7%9A%84-scanAndLockForPut-%E6%96%B9%E6%B3%95"><span class="toc-text">3.4. Segment çš„ scanAndLockForPut æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-%E6%A8%A1%E6%8B%9F%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B"><span class="toc-text">3.5. æ¨¡æ‹Ÿå¤šçº¿ç¨‹çš„ä»£ç æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-text">3.5.1. æµç¨‹å›¾</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-%E6%89%A9%E5%AE%B9%E5%AE%89%E5%85%A8"><span class="toc-text">4. æ‰©å®¹å®‰å…¨</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-text">4.1. æºç åˆ†æ</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-%E9%9B%86%E5%90%88%E9%95%BF%E5%BA%A6%E8%8E%B7%E5%8F%96"><span class="toc-text">5. é›†åˆé•¿åº¦è·å–</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-%E5%8F%82%E8%80%83"><span class="toc-text">6. å‚è€ƒ</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/06/13/012-%E7%BB%8F%E9%AA%8C%E4%B8%93%E9%A2%98/%E7%BB%8F%E9%AA%8C%E4%B8%93%E9%A2%98-%E9%A3%8E%E6%8E%A7%E7%B3%BB%E7%BB%9F-2%E3%80%81%E9%A3%8E%E6%8E%A7%E4%B8%AD%E5%8F%B0/" title="æ— é¢˜"><img src="https://picsum.photos/1920/1081" onerror='this.onerror=null,this.src="/null"' alt="æ— é¢˜"></a><div class="content"><a class="title" href="/2023/06/13/012-%E7%BB%8F%E9%AA%8C%E4%B8%93%E9%A2%98/%E7%BB%8F%E9%AA%8C%E4%B8%93%E9%A2%98-%E9%A3%8E%E6%8E%A7%E7%B3%BB%E7%BB%9F-2%E3%80%81%E9%A3%8E%E6%8E%A7%E4%B8%AD%E5%8F%B0/" title="æ— é¢˜">æ— é¢˜</a><time datetime="2023-06-13T23:32:43.044Z" title="å‘è¡¨äº 2023-06-14 07:32:43">2023-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/13/005-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%93%E9%A2%98/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%93%E9%A2%98-15%E3%80%81%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" title="åˆ†å¸ƒå¼ä¸“é¢˜-15ã€é“¾è·¯è¿½è¸ª"><img src="https://picsum.photos/1920/962" onerror='this.onerror=null,this.src="/null"' alt="åˆ†å¸ƒå¼ä¸“é¢˜-15ã€é“¾è·¯è¿½è¸ª"></a><div class="content"><a class="title" href="/2023/06/13/005-%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%93%E9%A2%98/%E5%88%86%E5%B8%83%E5%BC%8F%E4%B8%93%E9%A2%98-15%E3%80%81%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA/" title="åˆ†å¸ƒå¼ä¸“é¢˜-15ã€é“¾è·¯è¿½è¸ª">åˆ†å¸ƒå¼ä¸“é¢˜-15ã€é“¾è·¯è¿½è¸ª</a><time datetime="2023-06-13T16:00:00.000Z" title="å‘è¡¨äº 2023-06-14 00:00:00">2023-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/13/013-%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/%E8%B5%84%E6%BA%90%E5%AF%BC%E8%88%AA/" title="èµ„æºå¯¼èˆª"><img src="https://picsum.photos/1920/992" onerror='this.onerror=null,this.src="/null"' alt="èµ„æºå¯¼èˆª"></a><div class="content"><a class="title" href="/2023/06/13/013-%E7%9F%A5%E8%AF%86%E7%AE%A1%E7%90%86/%E8%B5%84%E6%BA%90%E5%AF%BC%E8%88%AA/" title="èµ„æºå¯¼èˆª">èµ„æºå¯¼èˆª</a><time datetime="2023-06-13T16:00:00.000Z" title="å‘è¡¨äº 2023-06-14 00:00:00">2023-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/13/014-AI%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/%E7%AE%97%E6%B3%95-0%E3%80%81%E6%B1%87%E6%80%BB/" title="ç®—æ³•-0ã€æ±‡æ€»"><img src="https://picsum.photos/1920/972" onerror='this.onerror=null,this.src="/null"' alt="ç®—æ³•-0ã€æ±‡æ€»"></a><div class="content"><a class="title" href="/2023/06/13/014-AI%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/%E7%AE%97%E6%B3%95-0%E3%80%81%E6%B1%87%E6%80%BB/" title="ç®—æ³•-0ã€æ±‡æ€»">ç®—æ³•-0ã€æ±‡æ€»</a><time datetime="2023-06-13T16:00:00.000Z" title="å‘è¡¨äº 2023-06-14 00:00:00">2023-06-14</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/06/13/014-AI%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/%E7%AE%97%E6%B3%95-1%E3%80%81%E9%A2%98%E7%9B%AE%E8%A7%A3%E6%9E%90/" title="ç®—æ³•-1ã€é¢˜ç›®è§£æ"><img src="https://picsum.photos/1920/1082" onerror='this.onerror=null,this.src="/null"' alt="ç®—æ³•-1ã€é¢˜ç›®è§£æ"></a><div class="content"><a class="title" href="/2023/06/13/014-AI%E7%AE%97%E6%B3%95%E4%B8%93%E9%A2%98/%E7%AE%97%E6%B3%95-1%E3%80%81%E9%A2%98%E7%9B%AE%E8%A7%A3%E6%9E%90/" title="ç®—æ³•-1ã€é¢˜ç›®è§£æ">ç®—æ³•-1ã€é¢˜ç›®è§£æ</a><time datetime="2023-06-13T16:00:00.000Z" title="å‘è¡¨äº 2023-06-14 00:00:00">2023-06-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image:url('https://picsum.photos/1920/912')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By Taylor Luo</div><div class="framework-info"><span>æ¡†æ¶</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="ç®€ç¹è½¬æ¢">ç¹</button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>(()=>{const o=()=>{twikoo.init(Object.assign({el:"#twikoo-wrap",envId:"https://twikoo-taylorluo.vercel.app/",region:"ap-shanghai",onCommentLoaded:function(){btf.loadLightbox(document.querySelectorAll("#twikoo .tk-content img:not(.tk-owo-emotion)"))}},null)),GLOBAL_CONFIG_SITE.isPost&&(()=>{const o=document.getElementById("twikoo-count");o&&twikoo.getCommentsCount({envId:"https://twikoo-taylorluo.vercel.app/",region:"ap-shanghai",urls:[window.location.pathname],includeReply:!1}).then((function(t){o.innerText=t[0].count})).catch((function(o){console.error(o)}))})()},t=()=>{"object"!=typeof twikoo?getScript("https://cdn.jsdelivr.net/npm/twikoo/dist/twikoo.all.min.js").then(o):setTimeout(o,0)};t()})()</script></div><script defer id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zindex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="æ‹¼æ,è‡ªå¼º,æ­£ç›´,è‡ªä¿¡" data-fontsize="15px" data-random="false" async></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>